
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="referrer" content="no-referrer" />
  <meta name="format-detection" content="telephone=no">
  <title>Split the Bill! v5.33</title>
  <meta name="theme-color" content="#121826">
  <style>
    :root {
      --bg: #0f172a; --text:#e5e7eb; --muted:#a3a3a3; --card:#111827; --border:#1f2937;
      --accent:#7c3aed; --accent-contrast:#111827; --radius:14px; --gap:14px;
      --shadow:0 10px 25px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:radial-gradient(900px 600px at 10% -10%, rgba(124,58,237,.22), transparent 60%),radial-gradient(800px 600px at 120% 10%, rgba(6,182,212,.18), transparent 60%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:20;padding:14px 12px;background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.85));border-bottom:1px solid rgba(255,255,255,.14);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    header .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center} header h1{margin:0;font-size:18px;color:#fff}
    header .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    header .controls a, header .controls button {font-size:12px;white-space:nowrap;text-decoration:none}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.38);background:rgba(255,255,255,.12);color:#fff;padding:12px 16px;border-radius:999px;cursor:pointer;backdrop-filter:blur(3px);transition:transform .08s, box-shadow .2s;position:relative;overflow:visible;display:inline-flex;align-items:center;gap:8px;line-height:1;min-height:40px; pointer-events:auto}
    .btn:active{transform:translateY(0)} .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.primary{border-color:transparent;background:#fff;color:var(--accent-contrast)}
    .btn.accent{border-color:transparent;background:#7c3aed;color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1)}
    #btnCoffee{background:#7c3aed !important;color:#fff !important;border-color:#6d28d9 !important;box-shadow:0 6px 18px rgba(124,58,237,.45);text-decoration:none !important}
    main{max-width:1200px;margin:18px auto;padding:0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)} @media(min-width:1000px){.grid{grid-template-columns:1.15fr 1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    h2{margin:0 0 10px;font-size:16px} h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
    .row-3{display:grid;grid-template-columns:1fr;gap:var(--gap)} @media(min-width:860px){.row-3{grid-template-columns:1fr 1fr 1fr}}
    .row-2{display:grid;grid-template-columns:1fr;gap:var(--gap)} @media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input[type=text],input[type=number],input[type=date],select{width:100%;padding:13px 14px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--text);outline:none;min-height:44px;font-size:14px}
    input:focus,select:focus{border-color:#7c3aed;box-shadow:0 0 0 4px rgba(124,58,237,.18)}
    .people-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.03);display:inline-flex;gap:8px;align-items:center}
    .badge input{width:120px;border:none;background:transparent;color:var(--text)}
    .badge .remove{border:1px solid #ef4444;color:#fff;background:#ef4444;border-radius:999px;padding:6px 10px;cursor:pointer}
    .chip{display:inline-block;font-size:12px;padding:2px 10px;border-radius:999px;margin:2px 4px 0 0;background:rgba(124,58,237,.16);border:1px solid rgba(124,58,237,.35);color:var(--text)}
    table{width:100%;border-collapse:collapse} th,td{font-size:13px;padding:10px;border-bottom:1px dashed rgba(31,41,55,.5);text-align:left}
    th{position:sticky;top:0;background:rgba(255,255,255,.03);z-index:1} td.right,th.right{text-align:right}
    .scroll{max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;font-size:13px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.02);margin:6px 0}
    .sep{height:1px;background:linear-gradient(to right, transparent, rgba(31,41,55,.7), transparent);margin:12px 0}
    .muted{color:var(--muted)} .right{text-align:right} .small{font-size:12px} .warn{color:#ef4444;font-size:12px;margin-top:6px}
    #err{display:none;background:#ef4444;color:#fff;padding:8px 12px;position:sticky;top:0;z-index:30}
    #inappBanner{display:none;position:fixed;left:12px;right:12px;bottom:12px;background:#1f2937;color:#fff;border:1px solid #374151;border-radius:12px;padding:12px;z-index:50;box-shadow:0 10px 24px rgba(0,0,0,.4)}
    #inappBanner button{margin-top:8px}
  </style>
</head>
<body>
  <div id="err">Terjadi error saat memuat skrip. Refresh halaman, atau buka file ini dengan browser lain.</div>
  <header>
    <div class="row">
      <h1>Split the Bill! v5.33</h1>
      <div class="controls">
        <button class="btn ghost" id="btnNew" type="button">Buat Ulang</button>
        <button class="btn" id="btnShareWA" type="button">Share WhatsApp</button>
        <a class="btn primary" id="btnCoffee" href="https://sociabuzz.com/orangpintarminumkopi/tribe" target="_blank" rel="noopener noreferrer">☕ Traktir Kopi</a>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h2>1) Orang & Pembayar</h2>
        <div class="row-3">
          <div>
            <label>Tambah Orang</label>
            <div style="display:flex; gap:8px;">
              <input type="text" id="personName" placeholder="mis. Yosef" autocomplete="off" autocapitalize="none" />
              <button class="btn accent" id="btnAddPerson" type="button">Tambah</button>
            </div>
          </div>
          <div>
            <label>Makan di</label>
            <input type="text" id="place" placeholder="mis. Warung Sederhana" />
          </div>
          <div>
            <label>Tanggal</label>
            <input type="date" id="dateField" />
          </div>
        </div>
        <div class="sep"></div>
        <label>Yang ikut Makan</label>
        <div id="peopleList" class="people-badges"></div>
        <div class="sep"></div>
        <div>
          <label>Yang Bayar Duluan</label>
          <select id="payer"></select>
        </div>
        <div class="row-2">
          <div>
            <label>Bank Pembayar</label>
            <input type="text" id="payerBank" placeholder="mis. BCA / BRI / Mandiri" />
          </div>
          <div>
            <label>No. Rekening Pembayar</label>
            <input type="text" id="payerAccount" placeholder="mis. 1234 5678 90" inputmode="numeric" />
            <div class="small muted" style="margin-top:6px;">Pastikan Nomor Rekening ditulis dengan Benar</div>
          </div>
        </div>
        <div>
          <label>Total Dibayar (Rp, sesuai struk)</label>
          <input type="number" id="paidTotal" value="0" step="100" inputmode="numeric" />
          <div id="paidWarn" class="warn" style="display:none;"></div>
        </div>
        <div class="sep"></div>
        <label>Catatan (opsional)</label>
        <input type="text" id="note" />
      </section>

      <section class="card">
        <h2>2) Item Makanan/Minuman</h2>
        <div class="card" style="padding:12px; border-style:dashed;">
          <div class="row-3">
            <div>
              <label>Nama Item</label>
              <input type="text" id="itemName" placeholder="mis. Nasi Goreng" />
            </div>
            <div>
              <label>Harga per Unit (Rp)</label>
              <input type="number" id="itemPrice" placeholder="25000" step="100" inputmode="numeric" />
            </div>
            <div>
              <label>Qty</label>
              <input type="number" id="itemQty" value="1" min="1" inputmode="numeric" />
            </div>
          </div>
          <div style="margin-top:10px;">
            <label>Pemakan (centang)</label>
            <div id="itemConsumers" class="people-badges"></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
            <button id="btnAddItem" class="btn accent" type="button">Tambah Item</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="scroll">
          <table id="itemsTable">
            <thead>
              <tr>
                <th style="width:24px;">#</th>
                <th>Item</th>
                <th class="right">Harga</th>
                <th class="right">Qty</th>
                <th class="right">Subtotal</th>
                <th>Siapa Saja</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="small muted">Pajak & service dialokasikan proporsional sesuai porsi item masing-masing.</p>
      </section>

      <section class="card" style="grid-column: 1 / -1;">
        <h2>3) Pengaturan Akhir, Hasil & Settlement</h2>
        <div class="row-3">
          <div class="card">
            <h3>Pengaturan Akhir</h3>
            <label>Service %</label>
            <input type="number" id="svcPctInput" step="0.1" min="0" value="5" inputmode="decimal" />
            <label style="margin-top:8px;">PPN %</label>
            <input type="number" id="taxPctInput" step="0.1" min="0" value="10" inputmode="decimal" />
            <label style="margin-top:8px;">Diskon/Cashback (Rp)</label>
            <input type="number" id="discount" value="0" min="0" step="100" inputmode="numeric" />
          </div>
          <div class="card">
            <h3>Ringkasan Tagihan</h3>
            <div id="summary"></div>
            <div class="sep"></div>
            <div class="small muted">Tempat: <strong id="placeSummary">-</strong> • Tanggal: <strong id="dateSummary">-</strong> • Bank: <strong id="bankSummary">-</strong> • Rek: <strong id="rekSummary">-</strong></div>
          </div>
          <div class="card">
            <h3>Per Orang</h3>
            <div id="perPerson"></div>
          </div>
        </div>
        <div class="sep"></div>
        <div class="card">
          <h3>Siapa Bayar Siapa</h3>
          <div id="settlements"></div>
          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="btn" id="btnShareWA2" type="button">Share WhatsApp</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="inappBanner">
    <div><strong>Buka di Safari untuk interaktivitas penuh.</strong><br>Beberapa penampil di dalam aplikasi (mis. WhatsApp/Files preview) mematikan tombol & skrip. Simpan ke Files → bagikan → <em>Buka di Safari</em>.</div>
    <button class="btn primary" id="openSafariBtn" type="button">Panduan Buka di Safari</button>
  </div>

<script>
(function(){
  function fail(msg){ var e=document.getElementById('err'); e.style.display='block'; if(msg) e.textContent = msg; }
  function bindTap(el, handler){
    if(!el) return;
    el.addEventListener('click', handler);
    el.addEventListener('pointerup', handler);
    el.addEventListener('touchend', function(e){ try{ e.preventDefault(); }catch(_){} handler(e); }, {passive:false});
  }
  function init(){
    try{
      function $(id){ return document.getElementById(id); }
      function fmtIDR(n){ try { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0); } catch(e){ return 'Rp ' + (Math.round(n||0)).toLocaleString('id-ID'); } }
      function escapeHtml(str){ return (str||"").replace(/[&<>\"']/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]); }); }

      var state = { people: [], items: [], payer: "", paidTotal: 0, payerBank: "", payerAccount: "", place: "", date: "", note: "", svcPct: 5, taxPct: 10, discount: 0 };
      function uid(){ return Math.random().toString(36).slice(2, 9); }

      function addPerson(name){
        name=(name||"").trim(); if(!name) return;
        for (var i=0;i<state.people.length;i++){ if(state.people[i].name.toLowerCase()===name.toLowerCase()){ alert("Nama sudah ada."); return; } }
        var p = { id: uid(), name: name }; state.people.push(p);
        if(!state.payer) state.payer = p.id;
        refreshPeople(); refreshPayerSelect(); renderItemConsumers(); refreshItems(); refresh();
      }
      function findPersonIndex(pid){ for (var i=0;i<state.people.length;i++){ if(state.people[i].id===pid) return i; } return -1; }
      function removePerson(pid){
        for (var i=0;i<state.items.length;i++){
          var filtered = state.items[i].consumers.filter(function(x){ return x !== pid; });
          state.items[i].consumers = filtered;
        }
        var idx = findPersonIndex(pid); if (idx>-1) state.people.splice(idx,1);
        if(state.payer===pid) state.payer = state.people.length? state.people[0].id : "";
        refreshPeople(); refreshPayerSelect(); renderItemConsumers(); refreshItems(); refresh();
      }
      function renamePerson(pid, newName){
        var idx = findPersonIndex(pid); if(idx===-1) return;
        state.people[idx].name = newName; refreshPeople(); refreshPayerSelect(); renderItemConsumers(); refreshItems(); refresh();
      }
      function addItem(name, price, qty, consumers){
        name=(name||"").trim(); price=+price||0; qty=Math.max(1, +qty||1);
        if(!name || price<=0){ alert("Nama & harga wajib diisi."); return; }
        if(!consumers.length){ alert("Pilih minimal satu orang."); return; }
        state.items.push({ id: uid(), name:name, price:price, qty:qty, consumers: consumers.slice(0) });
        $('itemName').value=''; $('itemPrice').value=''; $('itemQty').value=1; renderItemConsumers(); refreshItems(); refresh();
      }
      function removeItem(iid){ state.items = state.items.filter(function(x){ return x.id!==iid; }); refreshItems(); refresh(); }

      function refreshPeople(){
        var wrap = $('peopleList'); wrap.innerHTML = '';
        for (var i=0;i<state.people.length;i++){
          var p = state.people[i];
          var d = document.createElement('div'); d.className = 'badge';
          var input = document.createElement('input'); input.value = p.name; (function(pid){ input.addEventListener('input', function(e){ renamePerson(pid, e.target.value); }); })(p.id);
          var btn = document.createElement('button'); btn.className='remove'; btn.textContent='Hapus'; (function(pid){ bindTap(btn, function(){ removePerson(pid); }); })(p.id);
          d.appendChild(input); d.appendChild(btn); wrap.appendChild(d);
        }
      }
      function refreshPayerSelect(){
        var sel = $('payer'); sel.innerHTML='';
        for (var i=0;i<state.people.length;i++){
          var p = state.people[i]; var opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; if(p.id===state.payer) opt.selected=true; sel.appendChild(opt);
        }
      }
      function renderItemConsumers(){
        var box = $('itemConsumers'); box.innerHTML='';
        for (var i=0;i<state.people.length;i++){
          var p = state.people[i];
          var label=document.createElement('label'); label.className='badge';
          var cb=document.createElement('input'); cb.type='checkbox'; cb.setAttribute('data-pid', p.id);
          var span=document.createElement('span'); span.textContent=p.name;
          label.appendChild(cb); label.appendChild(span); box.appendChild(label);
        }
      }
      function getConsumersFromForm(){
        var box = $('itemConsumers'); var inputs = box.querySelectorAll('input[type=checkbox]'); var res=[];
        for (var i=0;i<inputs.length;i++){ if (inputs[i].checked) res.push(inputs[i].getAttribute('data-pid')); }
        return res;
      }
      function refreshItems(){
        var tb = $('itemsTable').querySelector('tbody'); tb.innerHTML='';
        for (var i=0;i<state.items.length;i++){
          var it = state.items[i];
          var tr = document.createElement('tr');
          var consumersNames = it.consumers.map(function(pid){
            var nm = state.people.find(function(pp){return pp.id===pid;}); return '<span class="chip">'+(nm?nm.name:"?")+'</span>';
          }).join(' ');
          tr.innerHTML = '<td>'+(i+1)+'</td><td>'+it.name+'</td><td class="right">'+fmtIDR(it.price)+'</td><td class="right">'+it.qty+'</td><td class="right">'+fmtIDR(it.price*it.qty)+'</td><td>'+consumersNames+'</td><td class="right"><button class="btn" data-iid="'+it.id+'">Hapus</button></td>';
          tb.appendChild(tr);
        }
        var btns = tb.querySelectorAll('button.btn');
        for (var i=0;i<btns.length;i++){ (function(b){ bindTap(b, function(){ removeItem(b.getAttribute('data-iid')); }); })(btns[i]); }
      }

      function calc(){
        var pre = {}; state.people.forEach(function(p){ pre[p.id]=0; });
        var subtotal=0;
        for (var i=0;i<state.items.length;i++){
          var it = state.items[i]; var line = it.price*it.qty; subtotal+=line; var share = line/it.consumers.length;
          for (var j=0;j<it.consumers.length;j++){ pre[it.consumers[j]] += share; }
        }
        var service = subtotal * (+state.svcPct||0) / 100;
        var tax = (subtotal + service) * (+state.taxPct||0) / 100;
        var discount = Math.min(+state.discount||0, subtotal + service + tax);
        var gross = subtotal + service + tax - discount;
        var step = 100; var roundedGross = Math.ceil(gross/step)*step; var roundingDelta = Math.round(roundedGross-gross);
        var sumPre = Object.values(pre).reduce(function(a,b){return a+b;},0) || 1;
        var nPeople = state.people.length || 1; var perPerson = {};
        state.people.forEach(function(p){ var ratio = pre[p.id]/sumPre; perPerson[p.id] = { preTax: pre[p.id], service: service*ratio, tax: tax*ratio, discount: discount/nPeople, total: 0 }; });
        state.people.forEach(function(p){ var v=perPerson[p.id]; v.total = v.preTax + v.service + v.tax - v.discount; });
        if (roundingDelta!==0 && state.people.length){
          var order = state.people.map(function(p){return {id:p.id, frac: perPerson[p.id].total%1};}).sort(function(a,b){return b.frac-a.frac;}).map(function(x){return x.id;});
          var remain = Math.abs(roundingDelta); var dir = roundingDelta>0?1:-1; for (var i=0;i<remain;i++){ var pid=order[i%order.length]; perPerson[pid].total += dir*1; }
        }
        var payerId = state.payer; var paidTotal = +state.paidTotal || 0; var expectedGross = Math.round(roundedGross);
        var actualPaid = paidTotal>0 ? paidTotal : expectedGross;
        var sumPer = state.people.reduce(function(a,p){return a+(perPerson[p.id].total||0);},0) || 1;
        var scale = actualPaid / sumPer; state.people.forEach(function(p){ perPerson[p.id].total = Math.round(perPerson[p.id].total * scale); });
        var settlements = []; state.people.forEach(function(p){ if(p.id!==payerId) settlements.push({from:p.id,to:payerId,amount:perPerson[p.id].total}); });
        return { subtotal:subtotal, service:service, tax:tax, discount:discount, gross:expectedGross, perPerson:perPerson, settlements:settlements, actualPaid:actualPaid };
      }

      function refreshSummary(){
        var r = calc();
        $('summary').innerHTML = '<div class="row-2" style="gap:8px;">'
          + '<div><span class="muted">Subtotal</span><br><strong>'+fmtIDR(r.subtotal)+'</strong></div>'
          + '<div class="right"><span class="muted">Service ('+(+state.svcPct||0)+'%)</span><br><strong>'+fmtIDR(r.service)+'</strong></div>'
          + '<div><span class="muted">PPN ('+(+state.taxPct||0)+'%) atas (Subtotal+Service)</span><br><strong>'+fmtIDR(r.tax)+'</strong></div>'
          + '<div class="right"><span class="muted">Diskon/Cashback</span><br><strong>- '+fmtIDR(r.discount)+'</strong></div>'
          + '<div><span class="muted">Total (pembulatan ke 100)</span><br><strong>'+fmtIDR(r.gross)+'</strong></div>'
          + '<div class="right"><span class="muted">Dibayar</span><br><strong>'+fmtIDR(r.actualPaid)+'</strong></div>'
          + '</div>';
        $('bankSummary').textContent = $('payerBank').value || '-';
        $('rekSummary').textContent = $('payerAccount').value || '-';
        $('placeSummary').textContent = $('place').value || '-';
        $('dateSummary').textContent = $('dateField').value || '-';
        var warn = $('paidWarn'); var paid = +($('paidTotal').value||0);
        if (paid && paid !== r.gross){ warn.style.display='block'; warn.textContent='Jumlah "Total Dibayar" ('+fmtIDR(paid)+') tidak sama dengan Total hasil akhir ('+fmtIDR(r.gross)+'). Ada kemungkinan salah input/kalkulasi. Harap dicek kembali.'; } else { warn.style.display='none'; warn.textContent=''; }
      }
      function refreshPerPerson(){
        var r = calc(); var out = $('perPerson'); out.innerHTML='';
        state.people.forEach(function(p){ var v = r.perPerson[p.id]; var row = document.createElement('div'); row.className='pill'; row.innerHTML = '<span><strong>'+p.name+'</strong> <span class="muted small">(item '+fmtIDR(v.preTax)+', svc '+fmtIDR(v.service)+', ppn '+fmtIDR(v.tax)+', diskon/cb -'+fmtIDR(v.discount)+')</span></span><span><strong>'+fmtIDR(v.total)+'</strong></span>'; out.appendChild(row); });
      }
      function refreshSettlements(){
        var r = calc(); var out = $('settlements'); out.innerHTML=''; if(!r.settlements.length){ out.innerHTML='<div class="muted">Tambahkan orang & item untuk melihat settlement.</div>'; return; }
        r.settlements.forEach(function(s){ var from = (state.people.find(function(pp){return pp.id===s.from;})||{}).name || '?'; var to = (state.people.find(function(pp){return pp.id===s.to;})||{}).name || '?'; var line = document.createElement('div'); line.className='pill'; line.innerHTML='<span>'+from+' ➜ '+to+'</span><strong>'+fmtIDR(s.amount)+'</strong>'; out.appendChild(line); });
      }
      function refresh(){
        state.taxPct = +($('taxPctInput').value||10);
        state.svcPct = +($('svcPctInput').value||5);
        state.discount = +($('discount').value||0);
        state.paidTotal = +($('paidTotal').value||0);
        state.payerBank = $('payerBank').value || '';
        state.payerAccount = $('payerAccount').value || '';
        state.place = $('place').value || '';
        state.date = $('dateField').value || '';
        state.note = $('note').value || '';
        refreshSummary(); refreshPerPerson(); refreshSettlements();
      }
      function refreshAll(){
        $('svcPctInput').value = state.svcPct; $('taxPctInput').value = state.taxPct;
        $('discount').value = state.discount; $('paidTotal').value = state.paidTotal; $('note').value = state.note;
        $('payerBank').value = state.payerBank; $('payerAccount').value = state.payerAccount;
        $('place').value = state.place; $('dateField').value = state.date;
        refreshPeople(); refreshPayerSelect(); renderItemConsumers(); refreshItems(); refresh();
      }

      function shareWA(){
        var r = calc(); var lines = ["Split the Bill! Waktunya Split Tagihan Makanan, yang udah bayar hapus nama ya!","", "💰 Per Orang:"];
        state.people.forEach(function(p){ lines.push('• '+p.name+': '+fmtIDR(r.perPerson[p.id].total)); });
        lines.push("", "🤝 Siapa Bayar Siapa:"); r.settlements.forEach(function(s){ var from = (state.people.find(function(pp){return pp.id===s.from;})||{}).name || '?'; var to = (state.people.find(function(pp){return pp.id===s.to;})||{}).name || '?'; lines.push('• '+from+' ➜ '+to+': '+fmtIDR(s.amount)); });
        var text = encodeURIComponent(lines.join("\n")); var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); var href = isMobile ? "whatsapp://send?text="+text : "https://wa.me/?text="+text; var win = window.open(href, "_blank", "noopener,noreferrer"); if (win) { win.opener=null; }
      }

      // Bind taps
      bindTap($('btnAddPerson'), function(){ addPerson($('personName').value); $('personName').value=''; $('personName').focus(); });
      bindTap($('btnAddItem'), function(){ var consumers = getConsumersFromForm(); addItem($('itemName').value, $('itemPrice').value, $('itemQty').value, consumers); });
      ['svcPctInput','taxPctInput','discount','paidTotal','payerBank','payerAccount','place','dateField','note'].forEach(function(id){ var el=$(id); el && el.addEventListener('input', refresh); });
      $('payer').addEventListener('change', function(e){ state.payer = e.target.value; refresh(); });
      bindTap($('btnNew'), function(){ if(confirm('Buat ulang dokumen ini? Semua data saat ini akan dihapus.')){ state = { people: [], items: [], payer: '', paidTotal: 0, payerBank: '', payerAccount: '', place: '', date: '', note: '', svcPct: 5, taxPct: 10, discount: 0 }; refreshAll(); } });
      bindTap($('btnShareWA'), shareWA); bindTap($('btnShareWA2'), shareWA);

      // In-app viewer hint (WhatsApp/FB/Files preview)
      var isInApp = /(WhatsApp|FBAN|FBIOS|Line|Instagram|Telegram)/i.test(navigator.userAgent);
      var isFile = location.protocol === 'file:';
      if ((isInApp && isFile)){
        var banner = $('inappBanner'); banner.style.display='block';
        bindTap($('openSafariBtn'), function(){ alert('Cara buka di Safari:\n1) Tap ikon Bagikan\n2) Pilih "Simpan ke Files"\n3) Buka app Files → tekan file → Bagikan → "Buka di Safari"'); });
      }

      refreshAll();
    }catch(e){ fail('Error JS: ' + (e && e.message ? e.message : e)); }
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
</body>
</html>
